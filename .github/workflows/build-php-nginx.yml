name: Build PHP+Nginx (Alpine) Image & Upload to Release

# 触发条件：1. 推送tag；2. 手动触发
on:
  push:
    tags:
      - 'v*'  # 匹配 v1.0.0、v2.1.1 等格式的tag
  workflow_dispatch:  # 手动触发（便于测试）

# 权限配置：需要创建Release、上传资产的权限
permissions:
  contents: write

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：拉取代码仓库（包含Dockerfile）
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤2：设置镜像名称和Tag（基于GitHub触发的Tag）
      - name: Set image name and tag
        id: set_tag
        run: |
          # 获取GitHub推送的Tag（如v1.0.0），去掉v前缀作为镜像版本
          IMAGE_TAG=${GITHUB_REF#refs/tags/v}
          # 定义镜像名称（可自定义）
          IMAGE_NAME="alpine-php-nginx"
          # 输出变量供后续步骤使用
          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "IMAGE_TAR=${IMAGE_NAME}-${IMAGE_TAG}.tar" >> $GITHUB_OUTPUT

      # 步骤3：构建Docker镜像（基于当前目录的Dockerfile）
      - name: Build Docker image
        run: |
          docker build -t ${{ steps.set_tag.outputs.IMAGE_NAME }}:${{ steps.set_tag.outputs.IMAGE_TAG }} .

      # 步骤4：将镜像导出为tar包（便于上传到Release）
      - name: Save image to tar file
        run: |
          docker save -o ${{ steps.set_tag.outputs.IMAGE_TAR }} ${{ steps.set_tag.outputs.IMAGE_NAME }}:${{ steps.set_tag.outputs.IMAGE_TAG }}

      # 步骤5：创建GitHub Release（关联Tag）
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          # Release标题（如：v1.0.0 - Alpine PHP+Nginx）
          name: ${{ github.ref_name }} - Alpine PHP+Nginx Image
          # Release描述（可自定义）
          body: |
            ## PHP+Nginx (Alpine) 镜像包
            - 镜像版本：${{ steps.set_tag.outputs.IMAGE_TAG }}
            - 基础镜像：Alpine 3.18
            - 包含组件：Nginx + PHP-FPM（版本可在Dockerfile中调整）
          # 关联的Tag（自动匹配触发的Tag）
          tag_name: ${{ github.ref_name }}
          # 是否为预发布（false=正式版，true=测试版）
          prerelease: false

      # 步骤6：上传镜像tar包到Release附件
      - name: Upload image tar to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub自动生成的令牌，无需手动配置
        with:
          # Release ID（从创建Release步骤获取）
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          # 要上传的文件路径
          asset_path: ./${{ steps.set_tag.outputs.IMAGE_TAR }}
          # 显示在Release中的文件名
          asset_name: ${{ steps.set_tag.outputs.IMAGE_TAR }}
          # 文件类型（tar包）
          asset_content_type: application/x-tar
